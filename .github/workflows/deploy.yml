name: Deploy to shinyapps.io

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libcurl4-openssl-dev \
          libssl-dev \
          libxml2-dev \
          libfontconfig1-dev \
          libharfbuzz-dev \
          libfribidi-dev \
          libfreetype6-dev \
          libpng-dev \
          libtiff5-dev \
          libjpeg-dev \
          pkg-config \
          make \
          gcc \
          g++
    
    - name: Install R packages (with retry)
      run: |
        R -e "options(repos = c(CRAN = 'https://cloud.r-project.org'))"
        # Instala pacotes básicos primeiro
        R -e "install.packages(c('curl', 'httr', 'jsonlite'), dependencies = TRUE)"
        # Instala outros pacotes
        R -e "install.packages(c('shiny', 'shinydashboard', 'plotly', 'DT', 'dplyr', 'lubridate', 'corrplot', 'reshape2', 'rsconnect'), dependencies = TRUE)"
    
    - name: Verify installations
      run: |
        R -e "if (!require('rsconnect')) stop('rsconnect not installed')"
        R -e "if (!require('shiny')) stop('shiny not installed')"
        R -e "if (!require('plotly')) stop('plotly not installed')"
        cat "✓ All packages installed successfully\n"
    
    - name: Deploy to shinyapps.io
      env:
        SHINYAPPS_NAME: ${{ secrets.SHINYAPPS_NAME }}
        SHINYAPPS_TOKEN: ${{ secrets.SHINYAPPS_TOKEN }}
        SHINYAPPS_SECRET: ${{ secrets.SHINYAPPS_SECRET }}
      run: |
        R -e "
          tryCatch({
            library(rsconnect)
            rsconnect::setAccountInfo(
              name = '${{ secrets.SHINYAPPS_NAME }}', 
              token = '${{ secrets.SHINYAPPS_TOKEN }}', 
              secret = '${{ secrets.SHINYAPPS_SECRET }}'
            )
            rsconnect::deployApp(
              appDir = '.', 
              appName = 'monitoralagoa', 
              account = '${{ secrets.SHINYAPPS_NAME }}',
              forceUpdate = TRUE
            )
            cat('Deploy successful!\\n')
          }, error = function(e) {
            cat('Deploy failed:', e$message, '\\n')
            quit(status = 1)
          })
        "
